name: 🔍 PR Quality Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-info:
    name: 📋 PR Information
    runs-on: ubuntu-latest
    
    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 📊 PR Stats
        run: |
          echo "## 📊 Pull Request Statistics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Files changed:** $(git diff --name-only origin/main..HEAD | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- **Lines added:** $(git diff --stat origin/main..HEAD | tail -1 | grep -o '[0-9]* insertion' | cut -d' ' -f1 || echo '0')" >> $GITHUB_STEP_SUMMARY
          echo "- **Lines removed:** $(git diff --stat origin/main..HEAD | tail -1 | grep -o '[0-9]* deletion' | cut -d' ' -f1 || echo '0')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 📁 Changed Files:" >> $GITHUB_STEP_SUMMARY
          git diff --name-only origin/main..HEAD | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY

  size-check:
    name: 📏 Bundle Size Check
    runs-on: ubuntu-latest
    
    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v4

      - name: 📦 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: 📋 Install dependencies
        run: npm ci

      - name: 🏗️ Build for bundle analysis
        run: npm run build

      - name: 📏 Analyze bundle size
        run: |
          echo "## 📦 Bundle Size Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f ".next/BUILD_ID" ]; then
            du -sh .next/ | cut -f1 | xargs -I {} echo "- **Total build size:** {}" >> $GITHUB_STEP_SUMMARY
            find .next/static -name "*.js" -type f -exec du -sh {} \; | head -10 | while read size file; do
              echo "- $file: $size" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "- ⚠️ Build directory not found" >> $GITHUB_STEP_SUMMARY
          fi

  changeset-check:
    name: 📝 Changeset Validation
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 🔍 Check for significant changes
        run: |
          # Check if there are changes in source files
          if git diff --name-only origin/main..HEAD | grep -E '\.(ts|tsx|js|jsx)$' > /dev/null; then
            echo "✅ Source code changes detected"
            echo "source_changes=true" >> $GITHUB_OUTPUT
          else
            echo "ℹ️ No source code changes"
            echo "source_changes=false" >> $GITHUB_OUTPUT
          fi
        id: changes

      - name: 📝 Suggest changelog entry
        if: steps.changes.outputs.source_changes == 'true'
        run: |
          echo "## 📝 Changelog Suggestion" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Consider adding a changelog entry for this PR:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Added" >> $GITHUB_STEP_SUMMARY
          echo "- [Brief description of new features]" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Changed" >> $GITHUB_STEP_SUMMARY
          echo "- [Brief description of changes]" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Fixed" >> $GITHUB_STEP_SUMMARY
          echo "- [Brief description of bug fixes]" >> $GITHUB_STEP_SUMMARY
